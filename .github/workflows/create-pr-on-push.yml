name: Create PR on branch push (scripted)
on:
  push:
    branches: ['feature/**']
jobs:
  create-pr:
    runs-on: ubuntu-latest
    steps:
      - name: Check out
        uses: actions/checkout@v4
      - name: Create PR if missing
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
          BRANCH: ${{ github.ref_name }}
        run: |
          echo "Checking PR for branch $BRANCH"
          api="https://api.github.com/repos/$REPO"
          # check existing PRs
          prs=$(curl -s -H "Authorization: token $GITHUB_TOKEN" "$api/pulls?head=${{ github.repository_owner }}:$BRANCH&state=open")
          count=$(echo "$prs" | jq 'length')
          echo "existing PRs: $count"
          if [ "$count" -eq 0 ]; then
            body="Auto-generated PR from branch $BRANCH"
            title="Auto PR: $BRANCH -> main"
            data=$(jq -n --arg t "$title" --arg b "$body" --arg base "main" --arg head "$BRANCH" '{title:$t, body:$b, base:$base, head:$head}')
            echo "Creating PR"
            curl -s -H "Authorization: token $GITHUB_TOKEN" -H "Content-Type: application/json" -d "$data" "$api/pulls" | jq '.'
          else
            echo "PR already exists"
          fi
