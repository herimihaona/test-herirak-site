name: Deploy to VPS
on:
  push:
    branches: [ main ]
jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.1
        with:
          ssh-private-key: ${{ secrets.DEPLOY_KEY }}
      - name: Sync files (verbose)
        run: |
          set -x
          mkdir -p deploy-logs
          rsync -avz --delete --exclude '.git' --rsync-path="sudo rsync" ./ ubuntu@213.32.19.189:/var/www/test.herirak.ovh/ 2>&1 | tee deploy-logs/rsync.log
          ssh -o StrictHostKeyChecking=no -v ubuntu@213.32.19.189 'sudo systemctl reload nginx' 2>&1 | tee deploy-logs/reload.log
      - name: Upload logs
        uses: actions/upload-artifact@v4
        with:
          name: deploy-logs
          path: deploy-logs
